<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mortgage Calculator — Fixvity</title>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --accent:#0b6ea8;
    --accent-2:#0f6a8a;
    --bg:#f7fafc;
    --card:#fff;
    --muted:#666;
    --success:#2a9c3f;
    --danger:#d9534f;
    --radius:10px;
    --container-max:1200px;
  }

  /* ===== GLOBAL / LAYOUT FIXES (prevent horizontal gutters/clipping) ===== */
  html, body { height:100%; margin:0; font-family:Inter,Arial,Helvetica,sans-serif; background:var(--bg); color:#111; overflow-x: hidden !important; -webkit-font-smoothing:antialiased; }
  .container{ max-width:var(--container-max); margin:22px auto; padding:18px; box-sizing:border-box; overflow-x: hidden; }
  /* ensure inner wrapper doesn't cause an internal horizontal scroll/gutter */
  .card { background:var(--card); border-radius:var(--radius); padding:14px; box-shadow:0 6px 18px rgba(13,30,45,0.06); overflow: visible; -webkit-overflow-scrolling: touch; }

  header h1{margin:0 0 6px;font-size:28px;color:var(--accent)}
  header p{margin:0;color:var(--muted)}

  /* grid */
  .grid{ display:grid; gap:18px; grid-template-columns:1fr; align-items:start; }
  @media(min-width:960px){ .grid{ grid-template-columns:420px 1fr; } }

  .form-row{ display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px; }
  .field{ flex:1; min-width:140px; }
  label{ display:block; font-size:13px; margin-bottom:6px; color:var(--muted) }
  input[type=number], input[type=text], select{ width:100%; padding:10px; border-radius:6px; border:1px solid #e3e8ee; font-size:15px; box-sizing:border-box; background:#fff; }

  .btn{ display:inline-block; padding:10px 16px; background:var(--accent); color:#fff; border-radius:8px; border:none; cursor:pointer; font-weight:600; }
  .btn.secondary{ background:#fff; color:var(--accent); border:1px solid #e3e8ee; }

  .controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px; }
  .results{ display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; }

  .stat{ background:#f6fbff; padding:12px; border-radius:8px; min-width:170px; }
  .stat h3{ margin:0; font-size:18px }
  .muted{ color:var(--muted); font-size:13px }

  .visual{ display:grid; grid-template-columns:1fr; gap:12px; margin-top:16px; }
  @media(min-width:960px){ .visual{ grid-template-columns:1fr 420px; } }

  canvas{ background:#fff; border-radius:8px; padding:8px; display:block; width:100% !important; height:100% !important; box-sizing:border-box; }

  table{ width:100%; border-collapse:collapse; background:#fff; border-radius:8px; overflow:hidden; }
  th, td{ padding:8px; border-bottom:1px solid #f2f4f7; text-align:left; font-size:14px; box-sizing:border-box; }
  th{ background:#2f6b9f; color:#fff; position:relative; }
  .small{ font-size:13px; color:var(--muted); }

  .tabs{ display:flex; gap:6px; margin-bottom:8px; }
  .tab{ padding:8px 10px; border-radius:6px; background:#f2f6fa; cursor:pointer; }
  .tab.active{ background:var(--accent); color:#fff; }

  .toolbar{ display:flex; gap:10px; align-items:center; }
  .toolbar .select{ margin-left:auto; display:flex; gap:8px; align-items:center; }

  /* table wrapper: allow scroll on small screens, prevent clipping */
  .tableWrap{ margin-top:10px; overflow-x:auto; -webkit-overflow-scrolling:touch; padding-bottom:6px; }

  /* Prevent layout overflow from long tables while maintaining readability.
     min-width ensures desktop layout stays consistent; adjust if necessary. */
  .tableWrap table { min-width:640px; width:100%; margin:0; }

  /* make the index column narrow to reduce horizontal pressure */
  .tableWrap table td:first-child, .tableWrap table th:first-child { width:56px; text-align:center; padding-left:12px; padding-right:12px; }

  /* mobile adjustments */
  @media (max-width:480px){
    header h1{ font-size:22px; }
    .tableWrap table { min-width:520px; }
    th, td { padding:8px; font-size:13px; }
  }

  /* print */
  @media print{
    .toolbar, .controls, input, select, button, .tabs { display:none !important; }
    .container{ max-width:100%; padding:0; }
    .card{ box-shadow:none; border-radius:0; padding:0; }
  }
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Mortgage Calculator</h1>
      <p class="muted">Monthly payment, amortization (monthly & annual), extra payments, taxes & costs, and printable schedule.</p>
    </header>

    <div class="toolbar" style="margin:12px 0;">
      <div style="margin-left:auto" class="toolbar-right">
        <label class="small muted" style="margin-right:8px">Currency</label>
        <select id="currency" style="padding:8px;border-radius:6px">
          <option value="USD" selected>USD - $</option>
          <option value="EUR">EUR - €</option>
          <option value="GBP">GBP - £</option>
          <option value="CAD">CAD - C$</option>
          <option value="AUD">AUD - A$</option>
          <option value="JPY">JPY - ¥</option>
          <option value="INR">INR - ₹</option>
        </select>
        <button id="printBtn" class="btn secondary" style="margin-left:8px">Print</button>
      </div>
    </div>

    <div class="grid">
      <!-- left column: inputs -->
      <div class="card">
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
          <div style="flex:1">
            <label>Home price</label>
            <input id="homePrice" type="number" value="400000" />
          </div>
          <div style="width:120px">
            <label>Down payment (%)</label>
            <input id="downPct" type="number" value="20" min="0" max="100" />
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Loan term (years)</label>
            <input id="termYears" type="number" value="30" min="1" />
          </div>
          <div class="field">
            <label>Interest rate (%)</label>
            <input id="rate" type="number" value="6.228" step="0.001" />
          </div>
          <div class="field">
            <label>Payments per year</label>
            <select id="freq">
              <option value="12" selected>Monthly (12)</option>
              <option value="26">Biweekly (26)</option>
              <option value="24">Semi-monthly (24)</option>
            </select>
          </div>
        </div>

        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <div style="flex:1">
            <label>Start date (month)</label>
            <select id="startMonth"></select>
          </div>
          <div style="width:120px">
            <label>Start year</label>
            <input id="startYear" type="number" />
          </div>
        </div>

        <hr style="border:none;border-top:1px solid #eef2f6;margin:10px 0">

        <div style="font-weight:700;margin-bottom:8px">Include Taxes & Costs</div>
        <div class="form-row">
          <div class="field">
            <label>Property tax (% of home / year)</label>
            <input id="propTaxPct" type="number" value="1.2" step="0.01" />
          </div>
          <div class="field">
            <label>Home insurance (annual $)</label>
            <input id="insurance" type="number" value="1500" />
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>PMI (annual $)</label>
            <input id="pmi" type="number" value="0" />
          </div>
          <div class="field">
            <label>HOA fee (annual $)</label>
            <input id="hoa" type="number" value="0" />
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Other costs (annual $)</label>
            <input id="otherCosts" type="number" value="4000" />
          </div>
          <div style="width:160px">
            <label>Annual cost increase (%)</label>
            <input id="costIncrease" type="number" value="0" step="0.1" />
          </div>
        </div>

        <hr style="border:none;border-top:1px solid #eef2f6;margin:10px 0">
        <div style="font-weight:700;margin-bottom:8px">Extra Payments</div>

        <div class="form-row">
          <div class="field">
            <label>Extra monthly pay</label>
            <input id="extraMonthly" type="number" value="0" />
          </div>
          <div class="field">
            <label>Extra yearly pay</label>
            <input id="extraYearly" type="number" value="0" />
          </div>
          <div style="min-width:160px">
            <label>Extra one-time pay</label>
            <input id="extraOne" type="number" value="0" />
          </div>
        </div>

        <div class="controls">
          <button id="calcBtn" class="btn">Calculate</button>
          <button id="resetBtn" class="btn secondary">Reset</button>
        </div>
      </div>

      <!-- right column: results -->
      <div>
        <div class="card">
          <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
            <div style="flex:1">
              <div class="small muted">Monthly Payment</div>
              <h2 id="monthly" style="margin:6px 0 0;font-size:24px;color:var(--accent)">$0.00</h2>
            </div>

            <div style="width:240px">
              <div class="small muted">Summary</div>
              <div style="display:flex;flex-direction:column;gap:6px;margin-top:6px">
                <div class="small">Total of payments: <strong id="total">$0.00</strong></div>
                <div class="small">Total interest: <strong id="interest">$0.00</strong></div>
                <div class="small">Payoff date: <strong id="payoff">—</strong></div>
              </div>
            </div>
          </div>

          <div class="visual">
            <div style="padding-top:12px">
              <canvas id="chart" height="240"></canvas>
            </div>

            <div>
              <div style="display:flex;align-items:center;justify-content:space-between">
                <strong>Amortization schedule</strong>
                <div class="tabs">
                  <div id="tabMonthly" class="tab active">Monthly</div>
                  <div id="tabAnnual" class="tab">Annual</div>
                </div>
              </div>

              <div style="margin-top:8px" class="card" id="tableCard">
                <div class="tableWrap" style="overflow:auto; max-height:420px;">
                  <table id="scheduleTable">
                    <thead id="thead"></thead>
                    <tbody id="tbody"></tbody>
                  </table>
                </div>
              </div>

            </div>

          </div>
        </div>
      </div>

    </div>
  </div>

<script>
/* ------------------ Helper utilities ------------------ */
const currencyInfo = {
  USD:{sym:'$',pos:'left',dec:2},
  EUR:{sym:'€',pos:'left',dec:2},
  GBP:{sym:'£',pos:'left',dec:2},
  CAD:{sym:'C$',pos:'left',dec:2},
  AUD:{sym:'A$',pos:'left',dec:2},
  JPY:{sym:'¥',pos:'left',dec:0},
  INR:{sym:'₹',pos:'left',dec:2}
};
function formatCurrency(v){
  const cur = document.getElementById('currency').value;
  const info = currencyInfo[cur] || currencyInfo.USD;
  const n = Number(v || 0);
  return info.pos==='left' ? info.sym + n.toLocaleString(undefined,{minimumFractionDigits:info.dec,maximumFractionDigits:info.dec}) : n.toLocaleString(undefined,{minimumFractionDigits:info.dec,maximumFractionDigits:info.dec}) + info.sym;
}
function toNumber(v){ const n=parseFloat(v); return isNaN(n)?0:n; }

/* DOM refs */
const homePriceEl = document.getElementById('homePrice');
const downPctEl = document.getElementById('downPct');
const termYearsEl = document.getElementById('termYears');
const rateEl = document.getElementById('rate');
const freqEl = document.getElementById('freq');
const startMonthEl = document.getElementById('startMonth');
const startYearEl = document.getElementById('startYear');

const propTaxEl = document.getElementById('propTaxPct');
const insuranceEl = document.getElementById('insurance');
const pmiEl = document.getElementById('pmi');
const hoaEl = document.getElementById('hoa');
const otherCostsEl = document.getElementById('otherCosts');
const costIncreaseEl = document.getElementById('costIncrease');

const extraMonthlyEl = document.getElementById('extraMonthly');
const extraYearlyEl = document.getElementById('extraYearly');
const extraOneEl = document.getElementById('extraOne');

const calcBtn = document.getElementById('calcBtn');
const resetBtn = document.getElementById('resetBtn');
const printBtn = document.getElementById('printBtn');
const currencyEl = document.getElementById('currency');

const monthlyOut = document.getElementById('monthly');
const totalOut = document.getElementById('total');
const interestOut = document.getElementById('interest');
const payoffOut = document.getElementById('payoff');

const chartCanvas = document.getElementById('chart');
const thead = document.getElementById('thead');
const tbody = document.getElementById('tbody');

const tabMonthly = document.getElementById('tabMonthly');
const tabAnnual = document.getElementById('tabAnnual');

let chart = null;
let lastSchedule = null;
let activeTab = 'monthly';

/* ------------------ Compute amortization schedule ------------------ */
function computeSchedule({
  loanAmount, annualRate, termYears, paymentsPerYear,
  extraMonthly, extraYearly, extraOneTime, startMonth, startYear
}){
  const P = loanAmount;
  const r = annualRate / 100 / paymentsPerYear;
  const n = Math.max(1, Math.round(termYears * paymentsPerYear));
  const regularPayment = (r===0) ? (P / n) : (P * (r / (1 - Math.pow(1 + r, -n))));

  let balance = P;
  let period = 0;
  const schedule = [];

  // convert extras to per-period approximation
  let extraPerPeriod = 0;
  if (paymentsPerYear === 12) extraPerPeriod = Number(extraMonthly) || 0;
  else if (paymentsPerYear === 26) extraPerPeriod = (Number(extraMonthly)||0) * 12 / 26;
  else extraPerPeriod = (Number(extraMonthly)||0) * 12 / paymentsPerYear;

  const extraOne = Number(extraOneTime) || 0;
  const extraYear = Number(extraYearly) || 0;

  let curYear = Number(startYear), curMonth = Number(startMonth);
  const pushDate = () => {
    const labelMonth = new Date(curYear, curMonth).toLocaleString(undefined,{month:'short'});
    return {month:curMonth,year:curYear,label:`${labelMonth} ${curYear}`};
  };

  while (balance > 0.0005 && period < n*3) {
    period++;
    const interest = balance * r;
    let principal = Math.max(0, regularPayment - interest);
    let extraThis = 0;
    extraThis += extraPerPeriod;
    if (extraYear && curMonth === Number(startMonth)) extraThis += extraYear;
    if (extraOne && period === 1) extraThis += extraOne;
    if (principal + extraThis > balance) extraThis = Math.max(0, balance - principal);

    const actualPayment = principal + interest + extraThis;
    balance = Math.max(0, balance - principal - extraThis);

    schedule.push({
      period,
      payment: actualPayment,
      interest,
      principal,
      extra: extraThis,
      balance,
      date: pushDate()
    });

    // advance date (approximate for biweekly)
    if (paymentsPerYear === 12) {
      curMonth++; if (curMonth>11) { curMonth = 0; curYear++; }
    } else if (paymentsPerYear === 26) {
      if (period % 2 === 0) { curMonth++; if (curMonth>11) { curMonth = 0; curYear++; } }
    } else {
      if (period % Math.max(1, Math.round(paymentsPerYear/12)) === 0) { curMonth++; if (curMonth>11) { curMonth = 0; curYear++; } }
    }

    if (schedule.length > n*3) break;
  }

  const totalPayment = schedule.reduce((s,x)=>s + x.payment,0);
  const totalInterest = schedule.reduce((s,x)=>s + x.interest,0);

  const annual = {};
  schedule.forEach(s=>{
    const y = s.date.year;
    if (!annual[y]) annual[y] = { year:y, payment:0, interest:0, principal:0, extra:0, endBalance:s.balance };
    annual[y].payment += s.payment;
    annual[y].interest += s.interest;
    annual[y].principal += s.principal;
    annual[y].extra += s.extra;
    annual[y].endBalance = s.balance;
  });
  const annualArray = Object.values(annual).sort((a,b)=>a.year-b.year);

  return {
    schedule, annual: annualArray, payment: regularPayment,
    totalPayment, totalInterest, periods: schedule.length
  };
}

/* ------------------ Rendering ------------------ */
function renderChart(schedule){
  const labels = schedule.map(s=>s.date.label);
  const balances = schedule.map(s=>s.balance);
  const interests = schedule.map(s=>s.interest);
  const payments = schedule.map(s=>s.payment);

  if (chart) chart.destroy();
  chart = new Chart(chartCanvas.getContext('2d'), {
    type:'line',
    data:{
      labels,
      datasets:[
        {label:'Balance',data:balances,borderColor:'#0b6ea8',backgroundColor:'rgba(11,110,168,0.06)',fill:true,tension:0.2},
        {label:'Interest',data:interests,borderColor:'#8cbf3f',backgroundColor:'rgba(140,191,63,0.06)',fill:false,tension:0.2},
        {label:'Payment',data:payments,borderColor:'#c0392b',backgroundColor:'rgba(192,57,43,0.04)',fill:false,tension:0.2}
      ]
    },
    options:{
      plugins:{legend:{position:'top'}},
      scales:{ y:{ ticks:{ callback: v => formatCurrency(v) } } },
      maintainAspectRatio:false,
      responsive:true
    }
  });

  // ensure resize then re-render labels (fix possible clipping)
  setTimeout(()=>{ try{ chart.resize(); }catch(e){} }, 120);
}

function renderMonthlyTable(schedule){
  thead.innerHTML = `<tr><th>#</th><th>Date</th><th>Payment</th><th>Interest</th><th>Principal</th><th>Extra</th><th>Ending Balance</th></tr>`;
  tbody.innerHTML = '';
  schedule.forEach(s=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${s.period}</td>
      <td>${s.date.label}</td>
      <td>${formatCurrency(s.payment)}</td>
      <td>${formatCurrency(s.interest)}</td>
      <td>${formatCurrency(s.principal)}</td>
      <td>${formatCurrency(s.extra)}</td>
      <td>${formatCurrency(s.balance)}</td>`;
    tbody.appendChild(tr);
  });
}

function renderAnnualTable(annual){
  thead.innerHTML = `<tr><th>Year</th><th>Payment</th><th>Interest</th><th>Principal</th><th>Extra</th><th>Ending Balance</th></tr>`;
  tbody.innerHTML = '';
  annual.forEach(a=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${a.year}</td>
      <td>${formatCurrency(a.payment)}</td>
      <td>${formatCurrency(a.interest)}</td>
      <td>${formatCurrency(a.principal)}</td>
      <td>${formatCurrency(a.extra)}</td>
      <td>${formatCurrency(a.endBalance)}</td>`;
    tbody.appendChild(tr);
  });
}

/* ------------------ Main calculate ------------------ */
function calculate(){
  const home = toNumber(homePriceEl.value);
  const downPct = toNumber(downPctEl.value);
  const loan = home * Math.max(0, (1 - downPct/100));
  const termYears = toNumber(termYearsEl.value);
  const rate = toNumber(rateEl.value);
  const freq = Number(freqEl.value);
  const startMonth = Number(startMonthEl.value || 0);
  const startYear = Number(startYearEl.value || new Date().getFullYear());

  const extraMonthly = toNumber(extraMonthlyEl.value);
  const extraYearly = toNumber(extraYearlyEl.value);
  const extraOne = toNumber(extraOneEl.value);

  const res = computeSchedule({
    loanAmount:loan, annualRate:rate, termYears, paymentsPerYear:freq,
    extraMonthly, extraYearly, extraOneTime:extraOne, startMonth, startYear
  });

  lastSchedule = res;
  monthlyOut.textContent = formatCurrency(res.payment);
  totalOut.textContent = formatCurrency(res.totalPayment);
  interestOut.textContent = formatCurrency(res.totalInterest);
  payoffOut.textContent = (res.schedule.length>0) ? res.schedule[res.schedule.length-1].date.label : '-';

  renderChart(res.schedule);
  if (activeTab === 'monthly') renderMonthlyTable(res.schedule); else renderAnnualTable(res.annual);

  // ensure charts resize after render (extra safety for Elementor)
  setTimeout(safeResizeCharts, 180);
}

/* ------------------ UI wiring ------------------ */
calcBtn.addEventListener('click', ()=> calculate());
resetBtn.addEventListener('click', ()=>{
  homePriceEl.value = 400000;
  downPctEl.value = 20;
  termYearsEl.value = 30;
  rateEl.value = 6.228;
  freqEl.value = 12;
  startMonthEl.value = new Date().getMonth();
  startYearEl.value = new Date().getFullYear();
  propTaxEl.value = 1.2;
  insuranceEl.value = 1500;
  pmiEl.value = 0;
  hoaEl.value = 0;
  otherCostsEl.value = 4000;
  costIncreaseEl.value = 0;
  extraMonthlyEl.value = 0;
  extraYearlyEl.value = 0;
  extraOneEl.value = 0;
  monthlyOut.textContent = formatCurrency(0);
  totalOut.textContent = formatCurrency(0);
  interestOut.textContent = formatCurrency(0);
  payoffOut.textContent = '-';
  tbody.innerHTML = '';
  if (chart) chart.destroy(); chart = null;
});
tabMonthly.addEventListener('click', ()=>{
  activeTab='monthly';
  tabMonthly.classList.add('active'); tabAnnual.classList.remove('active');
  if (lastSchedule) renderMonthlyTable(lastSchedule.schedule);
});
tabAnnual.addEventListener('click', ()=>{
  activeTab='annual';
  tabAnnual.classList.add('active'); tabMonthly.classList.remove('active');
  if (lastSchedule) renderAnnualTable(lastSchedule.annual);
});

printBtn.addEventListener('click', ()=> window.print());

currencyEl.addEventListener('change', ()=>{
  if (!lastSchedule) return;
  monthlyOut.textContent = formatCurrency(lastSchedule.payment);
  totalOut.textContent = formatCurrency(lastSchedule.totalPayment);
  interestOut.textContent = formatCurrency(lastSchedule.totalInterest);
  if (activeTab==='monthly') renderMonthlyTable(lastSchedule.schedule);
  else renderAnnualTable(lastSchedule.annual);
  if (chart) { renderChart(lastSchedule.schedule); }
});

/* ------------------ Resize helpers (fix clipped axis & Elementor rendering) ------------------ */
function safeResizeCharts(){
  try {
    if (chart && typeof chart.resize === 'function') chart.resize();
    // Chart.js stores instances in Chart.instances (v4+) or Chart.helpers; attempt safe approach:
    if (window.Chart && window.Chart.instances) {
      Object.values(window.Chart.instances).forEach(c => { try { c.resize(); } catch(e){} });
    }
  } catch(e){}
  // reset horizontal scroll on container to remove thin left gutter artifacts
  const cont = document.querySelector('.container');
  if (cont) cont.scrollLeft = 0;
}
window.addEventListener('load', ()=>{ setTimeout(safeResizeCharts, 120); setTimeout(safeResizeCharts, 600); });
window.addEventListener('resize', ()=>{ clearTimeout(window._resizeTimer); window._resizeTimer = setTimeout(safeResizeCharts, 120); });
window.addEventListener('orientationchange', ()=> setTimeout(safeResizeCharts, 200));

/* ------------------ Init: populate months and run first calc ------------------ */
document.addEventListener('DOMContentLoaded', ()=>{
  // fill startMonth options without document.write (works in WP/Elementor)
  const months = [...Array(12).keys()].map(m => new Date(0,m).toLocaleString(undefined,{month:'short'}));
  startMonthEl.innerHTML = months.map((label, idx)=>`<option value="${idx}">${label}</option>`).join('');
  startMonthEl.value = new Date().getMonth();
  startYearEl.value = new Date().getFullYear();

  // initial calculation
  calculate();
});
</script>
</body>
</html>
