<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mortgage Calculator — Fixvity</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --accent:#1f6fb6;
    --bg:#f7fbfd;
    --card:#ffffff;
    --muted:#6b7280;
    --radius:12px;
    --shadow: 0 8px 28px rgba(10,20,30,0.06);
    --container-max:1100px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:#111;background:var(--bg);-webkit-font-smoothing:antialiased}
  a{color:var(--accent);text-decoration:none}

  .wrap{max-width:var(--container-max);margin:22px auto;padding:18px;overflow-x:hidden}
  header h1{margin:0;font-size:36px;color:var(--accent)}
  header p.lead{margin:8px 0 18px;color:var(--muted);font-size:16px}

  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;margin-bottom:18px;overflow:visible}

  .grid{display:grid;gap:18px;grid-template-columns:1fr 420px;align-items:start}
  @media (max-width:1024px){ .grid{grid-template-columns:1fr;} }

  .form-row{display:flex;gap:12px}
  .col{flex:1;min-width:0}
  .form-group{margin-bottom:12px}
  label{display:block;font-size:14px;color:var(--muted);margin-bottom:8px}
  input[type="text"], input[type="number"], select, textarea{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:8px;font-size:16px;background:#fff}
  .small{font-size:13px;color:var(--muted)}

  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
  .btn{display:inline-block;padding:10px 16px;border-radius:8px;border:0;background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
  .btn.alt{background:#eef6fb;color:var(--accent);border:1px solid #dfeffb}
  .btn.ghost{background:#fff;border:1px solid #e6eef8;color:var(--muted)}

  .results{display:flex;flex-direction:column;gap:14px}
  .result-row{display:flex;justify-content:space-between;align-items:center;background:#fff;padding:12px;border-radius:8px;border:1px solid #f1f5f9}
  .result-row h3{margin:0;color:var(--accent);font-size:16px}
  .result-row .value{font-weight:700;font-size:18px}

  .chartWrap{background:var(--card);padding:12px;border-radius:8px;box-shadow:var(--shadow);overflow:hidden}
  .chartBox{height:260px; position:relative;}
  .chartBox.tall{height:300px}
  @media (max-width:600px){ .chartBox{height:200px} .chartBox.tall{height:260px} }

  /* Ensure canvas fills container */
  canvas{ width:100% !important; height:100% !important; display:block; }

  /* Table responsiveness */
  .tableWrap{margin-top:10px;overflow:hidden;background:transparent}
  .tableInner{ overflow-x:auto; -webkit-overflow-scrolling:touch; padding-bottom:10px; width:100%; }
  .tableInner table{ min-width:640px; width:auto; border-collapse:collapse; background:#fff; border-radius:8px; overflow:hidden; }
  th,td{padding:10px;border-bottom:1px solid #eef2f7;text-align:left; font-size:14px}
  th{background:#2f6b9f;color:#fff; position:sticky; top:0}
  @media (max-width:640px){
    th, td { padding:8px; font-size:13px; }
    .chartBox{height:200px !important;}
  }

  .tableToggle{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .tabBtn{padding:10px 14px;border-radius:8px;border:1px solid #dfe6ee;background:#f7fbff;cursor:pointer}
  .tabBtn.active{background:var(--accent);color:#fff;border-color:var(--accent)}

  /* small screen adjustments */
  @media (max-width:600px){
    .wrap{padding:12px}
    header h1{font-size:28px}
    .card{padding:14px}
    .controls{justify-content:flex-start}
  }

  @media print{
    .controls, label, .small, .tabBtn { display:none !important; }
    body{background:#fff}
    .wrap{max-width:100%;padding:0}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Mortgage Calculator</h1>
      <p class="lead">Monthly payment, amortization schedule (monthly & annual), charts, currency & printable results.</p>
    </header>

    <!-- toolbar: currency only (print removed from top) -->
    <div class="card" style="margin-bottom:12px;display:flex;align-items:center;gap:12px;flex-wrap:wrap">
      <div style="flex:1">
        <div class="small">Currency & Format</div>
        <select id="currencyTop" style="width:220px;padding:10px;border-radius:8px;border:1px solid #e6eef8">
          <option value="USD">USD - $</option>
          <option value="EUR">EUR - €</option>
          <option value="GBP">GBP - £</option>
          <option value="CAD">CAD - C$</option>
          <option value="AUD">AUD - A$</option>
          <option value="JPY">JPY - ¥</option>
          <option value="INR">INR - ₹</option>
        </select>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Inputs -->
      <div>
        <div class="card">
          <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
            <div style="flex:1">
              <label>Home price</label>
              <input id="homePrice" type="number" value="400000" />
            </div>
            <div style="width:140px">
              <label>Down payment (%)</label>
              <input id="downPct" type="number" value="20" min="0" max="100" />
            </div>
          </div>

          <div class="form-row">
            <div class="col form-group">
              <label>Loan term (years)</label>
              <input id="termYears" type="number" value="30" min="1" />
            </div>
            <div class="col form-group">
              <label>Interest rate (%)</label>
              <input id="rate" type="number" value="6.228" step="0.001" />
            </div>
            <div class="col form-group">
              <label>Payments per year</label>
              <select id="freq">
                <option value="12" selected>Monthly (12)</option>
                <option value="26">Biweekly (26)</option>
                <option value="24">Semi-monthly (24)</option>
              </select>
            </div>
          </div>

          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
            <div style="flex:1">
              <label>Start month</label>
              <select id="startMonth"></select>
            </div>
            <div style="width:120px">
              <label>Start year</label>
              <input id="startYear" type="number" />
            </div>
          </div>

          <hr style="border:none;border-top:1px solid #eef2f6;margin:10px 0">

          <div style="font-weight:700;margin-bottom:8px">Include Taxes & Costs</div>

          <div class="form-row">
            <div class="col form-group">
              <label>Property tax (% / year)</label>
              <input id="propTaxPct" type="number" value="1.2" step="0.01" />
            </div>
            <div class="col form-group">
              <label>Home insurance (annual $)</label>
              <input id="insurance" type="number" value="1500" />
            </div>
          </div>

          <div class="form-row">
            <div class="col form-group">
              <label>PMI (annual $)</label>
              <input id="pmi" type="number" value="0" />
            </div>
            <div class="col form-group">
              <label>HOA (annual $)</label>
              <input id="hoa" type="number" value="0" />
            </div>
          </div>

          <div class="form-row">
            <div class="col form-group">
              <label>Other costs (annual $)</label>
              <input id="otherCosts" type="number" value="4000" />
            </div>
            <div class="col form-group">
              <label>Annual cost increase (%)</label>
              <input id="costIncrease" type="number" value="0" step="0.1" />
            </div>
          </div>

          <hr style="border:none;border-top:1px solid #eef2f6;margin:10px 0">

          <div style="font-weight:700;margin-bottom:8px">Extra Payments</div>

          <div class="form-row">
            <div class="col form-group">
              <label>Extra monthly</label>
              <input id="extraMonthly" type="number" value="0" />
            </div>
            <div class="col form-group">
              <label>Extra yearly</label>
              <input id="extraYearly" type="number" value="0" />
            </div>
            <div class="col form-group">
              <label>Extra one-time</label>
              <input id="extraOne" type="number" value="0" />
            </div>
          </div>

          <div class="controls">
            <button id="calcBtn" class="btn">Calculate</button>
            <button id="resetBtn" class="btn alt">Reset</button>
            <button id="csvBtn" class="btn alt">Download CSV</button>
            <!-- Print moved here (below CSV) -->
            <button id="printBtn" class="btn ghost" style="margin-left:8px">Print</button>
          </div>

          <div class="small" style="margin-top:10px">Tip: fees/tax are included in the loan calculation by default. Edit logic to change behavior.</div>
        </div>
      </div>

      <!-- RIGHT: Results & Charts -->
      <div>
        <div class="card">
          <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
            <div style="flex:1">
              <div class="small">Monthly Payment</div>
              <h2 id="monthlyOut" style="margin:6px 0 0;font-size:24px;color:var(--accent)">$0.00</h2>
            </div>

            <div style="width:260px">
              <div class="small">Summary</div>
              <div style="display:flex;flex-direction:column;gap:6px;margin-top:6px">
                <div class="small">Total of payments: <strong id="totalOut">$0.00</strong></div>
                <div class="small">Total interest: <strong id="interestOut">$0.00</strong></div>
                <div class="small">Payoff date: <strong id="payoffOut">—</strong></div>
              </div>
            </div>
          </div>

          <div style="display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px" id="visualWrap">
            <div class="chartWrap">
              <div class="chartBox tall" style="height:300px">
                <canvas id="amortChart"></canvas>
              </div>
            </div>

            <div>
              <div style="display:flex;align-items:center;justify-content:space-between">
                <strong>Amortization schedule</strong>
                <div class="tableToggle">
                  <button id="btnAnnual" class="tabBtn">Annual</button>
                  <button id="btnMonthly" class="tabBtn active">Monthly</button>
                </div>
              </div>

              <div class="tableWrap card" id="scheduleWrap" style="margin-top:12px;padding:12px">
                <div class="tableInner" id="annualTable" style="display:none"></div>
                <div class="tableInner" id="monthlyTable"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div> <!-- grid end -->
  </div> <!-- wrap end -->

<script>
/* -------------------------
  Utilities / formatting
------------------------- */
const currencyInfo = {
  USD:{sym:'$',dec:2}, EUR:{sym:'€',dec:2}, GBP:{sym:'£',dec:2},
  CAD:{sym:'C$',dec:2}, AUD:{sym:'A$',dec:2}, JPY:{sym:'¥',dec:0}, INR:{sym:'₹',dec:2}
};
function formatCurrency(v){
  const cur = document.getElementById('currencyTop').value || 'USD';
  const info = currencyInfo[cur] || currencyInfo.USD;
  const n = Number(v || 0);
  return info.sym + n.toLocaleString(undefined,{minimumFractionDigits:info.dec,maximumFractionDigits:info.dec});
}
function toNumber(v){ const n = parseFloat(v); return isNaN(n) ? 0 : n; }

/* populate startMonth select */
(function fillMonths(){
  const sel = document.getElementById('startMonth');
  sel.innerHTML = '';
  for(let m=0;m<12;m++){
    const opt = document.createElement('option');
    opt.value = m;
    opt.text = new Date(0,m).toLocaleString(undefined,{month:'short'});
    sel.appendChild(opt);
  }
})();

/* DOM refs */
const homePriceEl = document.getElementById('homePrice');
const downPctEl = document.getElementById('downPct');
const termYearsEl = document.getElementById('termYears');
const rateEl = document.getElementById('rate');
const freqEl = document.getElementById('freq');
const startMonthEl = document.getElementById('startMonth');
const startYearEl = document.getElementById('startYear');

const propTaxEl = document.getElementById('propTaxPct');
const insuranceEl = document.getElementById('insurance');
const pmiEl = document.getElementById('pmi');
const hoaEl = document.getElementById('hoa');
const otherCostsEl = document.getElementById('otherCosts');
const costIncreaseEl = document.getElementById('costIncrease');

const extraMonthlyEl = document.getElementById('extraMonthly');
const extraYearlyEl = document.getElementById('extraYearly');
const extraOneEl = document.getElementById('extraOne');

const calcBtn = document.getElementById('calcBtn');
const resetBtn = document.getElementById('resetBtn');
const csvBtn = document.getElementById('csvBtn');
const printBtn = document.getElementById('printBtn');

const monthlyOut = document.getElementById('monthlyOut');
const totalOut = document.getElementById('totalOut');
const interestOut = document.getElementById('interestOut');
const payoffOut = document.getElementById('payoffOut');

const amortCtxEl = document.getElementById('amortChart');
const monthlyTableEl = document.getElementById('monthlyTable');
const annualTableEl = document.getElementById('annualTable');
const btnAnnual = document.getElementById('btnAnnual');
const btnMonthly = document.getElementById('btnMonthly');

let amortChart = null;
let lastResult = null;
let activeView = 'monthly';

/* Core schedule computation (periodic) */
function computeSchedule(opts){
  const { loanAmount, annualRate, termYears, paymentsPerYear, extraMonthly, extraYearly, extraOneTime, startMonth, startYear } = opts;
  const P = loanAmount;
  const r = annualRate/100/paymentsPerYear;
  const n = Math.max(1, Math.round(termYears * paymentsPerYear));
  const regularPayment = (r===0) ? (P/n) : (P * (r / (1 - Math.pow(1+r, -n))));
  let balance = P;
  let period = 0;
  const schedule = [];
  let curMonth = startMonth, curYear = startYear;

  let extraPeriod = 0;
  if (paymentsPerYear === 12) extraPeriod = Number(extraMonthly) || 0;
  else if (paymentsPerYear === 26) extraPeriod = (Number(extraMonthly)||0) * 12 / 26;
  else extraPeriod = (Number(extraMonthly)||0) * 12 / paymentsPerYear;

  while (balance > 0.0005 && period < n * 3){
    period++;
    const interest = balance * r;
    let principal = Math.max(0, regularPayment - interest);
    let extraThis = 0;
    extraThis += extraPeriod;
    if (Number(extraYearly) && curMonth === Number(startMonth)) extraThis += Number(extraYearly);
    if (period === 1 && Number(extraOneTime)) extraThis += Number(extraOneTime);
    if (principal + extraThis > balance) extraThis = Math.max(0, balance - principal);
    const payment = principal + interest + extraThis;
    balance = Math.max(0, balance - principal - extraThis);
    const labelMonth = new Date(curYear, curMonth).toLocaleString(undefined,{month:'short'});
    schedule.push({ period, payment, interest, principal, extra: extraThis, balance, date: { month: curMonth, year: curYear, label: `${labelMonth} ${curYear}` } });

    if (paymentsPerYear === 12){
      curMonth++; if (curMonth > 11){ curMonth = 0; curYear++; }
    } else if (paymentsPerYear === 26){
      if (period % 2 === 0){ curMonth++; if (curMonth > 11){ curMonth = 0; curYear++; } }
    } else {
      if (period % Math.max(1, Math.round(paymentsPerYear/12)) === 0){ curMonth++; if (curMonth > 11){ curMonth = 0; curYear++; } }
    }
    if (schedule.length > n*3) break;
  }

  const totalPayment = schedule.reduce((s,x)=>s+x.payment,0);
  const totalInterest = schedule.reduce((s,x)=>s+x.interest,0);

  const annualMap = {};
  schedule.forEach(s=>{
    const y = s.date.year;
    if (!annualMap[y]) annualMap[y] = { year: y, payment:0, interest:0, principal:0, extra:0, endBalance: s.balance };
    annualMap[y].payment += s.payment;
    annualMap[y].interest += s.interest;
    annualMap[y].principal += s.principal;
    annualMap[y].extra += s.extra;
    annualMap[y].endBalance = s.balance;
  });
  const annual = Object.values(annualMap).sort((a,b)=>a.year-b.year);

  return { schedule, annual, payment: regularPayment, totalPayment, totalInterest, periods: schedule.length };
}

/* Chart rendering with mobile adapt */
function renderChart(schedule){
  const labels = schedule.map(s=>s.date.label);
  const balances = schedule.map(s=>s.balance);
  const interests = schedule.map(s=>s.interest);
  const payments = schedule.map(s=>s.payment);

  if (amortChart) amortChart.destroy();

  const ctx = amortCtxEl.getContext('2d');
  amortChart = new Chart(ctx, {
    type:'line',
    data:{
      labels,
      datasets:[
        {label:'Balance',data:balances,borderColor:'#1f77b4',backgroundColor:'rgba(31,111,182,0.06)',fill:true,tension:0.2, pointRadius:0, borderWidth:3},
        {label:'Interest',data:interests,borderColor:'#7ac142',fill:false,tension:0.2, pointRadius:0, borderWidth:2},
        {label:'Payment',data:payments,borderColor:'#d44',fill:false,tension:0.2, pointRadius:0, borderWidth:2}
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{
          position:'top',
          align:'start',
          labels:{ boxWidth:12, padding:8, usePointStyle:true }
        },
        tooltip: { mode:'index', intersect:false }
      },
      layout: { padding: { left: 40, right: 12, top: 6, bottom: 6 } },
      scales:{
        y:{
          ticks:{
            callback: v => {
              const small = (window.innerWidth || document.documentElement.clientWidth) <= 600;
              return small ? formatCurrencyShort(v) : formatCurrency(v);
            },
            maxTicksLimit: 6,
          },
          grid:{ color: '#eef4f8' }
        },
        x:{
          ticks:{
            autoSkip:true,
            maxRotation:0,
            minRotation:0,
            maxTicksLimit: 6,
            callback: function(val, idx){
              // show ~5 labels on mobile, more on desktop
              const small = (window.innerWidth || document.documentElement.clientWidth) <= 600;
              const step = small ? Math.ceil(labels.length / 5) : Math.ceil(labels.length / 12);
              return (idx % step === 0) ? labels[idx] : '';
            }
          },
          grid:{ display:false }
        }
      },
      interaction:{ mode:'nearest', intersect:false },
      elements:{ line:{ tension:0.2 } }
    }
  });

  adaptChartForMobile();
}

function adaptChartForMobile(){
  if (!amortChart) return;
  const small = (window.innerWidth || document.documentElement.clientWidth) <= 600;

  amortChart.options.layout.padding.left = small ? 18 : 40;
  amortChart.options.layout.padding.right = small ? 8 : 12;

  // hide legend on small screens to save vertical space
  amortChart.options.plugins.legend.display = !small;
  amortChart.options.plugins.legend.labels.boxWidth = small ? 10 : 12;

  if (amortChart.options.scales.x && amortChart.options.scales.x.ticks){
    amortChart.options.scales.x.ticks.maxTicksLimit = small ? 5 : 12;
  }
  if (amortChart.options.scales.y && amortChart.options.scales.y.ticks){
    amortChart.options.scales.y.ticks.maxTicksLimit = small ? 6 : 10;
  }

  amortChart.update();
}

let _chartResizeTimer = null;
window.addEventListener('resize', ()=>{
  if (_chartResizeTimer) clearTimeout(_chartResizeTimer);
  _chartResizeTimer = setTimeout(()=> adaptChartForMobile(), 120);
});

/* Table rendering: update tbody only */
function renderMonthlyTable(schedule){
  if (!monthlyTableEl.querySelector('table')) {
    monthlyTableEl.innerHTML = '<table><thead><tr><th>#</th><th>Date</th><th>Payment</th><th>Interest</th><th>Principal</th><th>Extra</th><th>Ending Balance</th></tr></thead><tbody></tbody></table>';
  }
  const tbody = monthlyTableEl.querySelector('tbody');
  tbody.innerHTML = '';
  schedule.forEach(s => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${s.period}</td>
      <td>${s.date.label}</td>
      <td>${formatCurrency(s.payment)}</td>
      <td>${formatCurrency(s.interest)}</td>
      <td>${formatCurrency(s.principal)}</td>
      <td>${formatCurrency(s.extra)}</td>
      <td>${formatCurrency(s.balance)}</td>`;
    tbody.appendChild(tr);
  });
}
function renderAnnualTable(annual){
  if (!annualTableEl.querySelector('table')) {
    annualTableEl.innerHTML = '<table><thead><tr><th>Year</th><th>Payment</th><th>Interest</th><th>Principal</th><th>Extra</th><th>Ending Balance</th></tr></thead><tbody></tbody></table>';
  }
  const tbody = annualTableEl.querySelector('tbody');
  tbody.innerHTML = '';
  annual.forEach(a=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${a.year}</td>
      <td>${formatCurrency(a.payment)}</td>
      <td>${formatCurrency(a.interest)}</td>
      <td>${formatCurrency(a.principal)}</td>
      <td>${formatCurrency(a.extra)}</td>
      <td>${formatCurrency(a.endBalance)}</td>`;
    tbody.appendChild(tr);
  });
}

/* Main calculate and render */
function calculate(){
  const home = toNumber(homePriceEl.value);
  const downPct = toNumber(downPctEl.value);
  const loan = home * (1 - downPct/100);
  const termYears = toNumber(termYearsEl.value);
  const rate = toNumber(rateEl.value);
  const freq = Number(freqEl.value);
  const startMonth = Number(startMonthEl.value || 0);
  const startYear = Number(startYearEl.value || new Date().getFullYear());

  const propTaxPct = toNumber(propTaxEl.value);
  const insurance = toNumber(insuranceEl.value);
  const pmi = toNumber(pmiEl.value);
  const hoa = toNumber(hoaEl.value);
  const otherCosts = toNumber(otherCostsEl.value);
  const costIncrease = toNumber(costIncreaseEl.value);

  const extraMonthly = toNumber(extraMonthlyEl.value);
  const extraYearly = toNumber(extraYearlyEl.value);
  const extraOne = toNumber(extraOneEl.value);

  const res = computeSchedule({
    loanAmount: loan,
    annualRate: rate,
    termYears,
    paymentsPerYear: freq,
    extraMonthly, extraYearly, extraOneTime: extraOne,
    startMonth, startYear
  });

  lastResult = res;

  // Show monthly payment including per-period extra (converted similar to schedule)
  let extraPeriod = 0;
  if (freq === 12) extraPeriod = extraMonthly;
  else if (freq === 26) extraPeriod = extraMonthly * 12 / 26;
  else extraPeriod = extraMonthly * 12 / freq;
  const shownPayment = (res.payment || 0) + extraPeriod;

  monthlyOut.textContent = formatCurrency(shownPayment);
  totalOut.textContent = formatCurrency(res.totalPayment);
  interestOut.textContent = formatCurrency(res.totalInterest);
  payoffOut.textContent = res.schedule.length ? res.schedule[res.schedule.length-1].date.label : '-';

  renderChart(res.schedule);

  if (activeView === 'monthly') {
    annualTableEl.style.display = 'none';
    monthlyTableEl.style.display = 'block';
    renderMonthlyTable(res.schedule);
  } else {
    monthlyTableEl.style.display = 'none';
    annualTableEl.style.display = 'block';
    renderAnnualTable(res.annual);
  }

  // ensure chart updates size
  setTimeout(()=>{ if (amortChart) amortChart.resize(); }, 120);
}

/* CSV download */
function downloadCSV(){
  if (!lastResult) return alert('Calculate first');
  const rows = [['Period','Date','Payment','Principal','Interest','Extra','EndingBalance']];
  lastResult.schedule.forEach(r => rows.push([
    r.period, r.date.label, r.payment.toFixed(2), r.principal.toFixed(2), r.interest.toFixed(2), r.extra.toFixed(2), r.balance.toFixed(2)
  ]));
  const csv = rows.map(r => r.join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'amortization.csv';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* UI wiring */
calcBtn.addEventListener('click', calculate);
resetBtn.addEventListener('click', ()=>{
  homePriceEl.value = 400000; downPctEl.value = 20; termYearsEl.value = 30; rateEl.value = 6.228;
  freqEl.value = 12; startMonthEl.value = new Date().getMonth(); startYearEl.value = new Date().getFullYear();
  propTaxEl.value = 1.2; insuranceEl.value = 1500; pmiEl.value = 0; hoaEl.value = 0; otherCostsEl.value = 4000; costIncreaseEl.value = 0;
  extraMonthlyEl.value = 0; extraYearlyEl.value = 0; extraOneEl.value = 0;
  monthlyOut.textContent = formatCurrency(0); totalOut.textContent = formatCurrency(0); interestOut.textContent = formatCurrency(0); payoffOut.textContent = '-';
  monthlyTableEl.innerHTML = ''; annualTableEl.innerHTML = ''; if (amortChart) amortChart.destroy(); lastResult = null;
});
csvBtn.addEventListener('click', downloadCSV);
printBtn.addEventListener('click', ()=> window.print());

btnMonthly.addEventListener('click', ()=>{
  activeView = 'monthly';
  btnMonthly.classList.add('active'); btnAnnual.classList.remove('active');
  monthlyTableEl.style.display = 'block';
  annualTableEl.style.display = 'none';
  if (lastResult) renderMonthlyTable(lastResult.schedule);
});
btnAnnual.addEventListener('click', ()=>{
  activeView = 'annual';
  btnAnnual.classList.add('active'); btnMonthly.classList.remove('active');
  monthlyTableEl.style.display = 'none';
  annualTableEl.style.display = 'block';
  if (lastResult) renderAnnualTable(lastResult.annual);
});

/* currency change: re-render numeric displays using new symbol */
document.getElementById('currencyTop').addEventListener('change', ()=>{
  if (!lastResult) return;
  // recompute shownPayment including extras (freq may be changed)
  const freq = Number(freqEl.value);
  let extraPeriod = 0;
  if (freq === 12) extraPeriod = toNumber(extraMonthlyEl.value);
  else if (freq === 26) extraPeriod = toNumber(extraMonthlyEl.value) * 12 / 26;
  else extraPeriod = toNumber(extraMonthlyEl.value) * 12 / freq;
  monthlyOut.textContent = formatCurrency((lastResult.payment||0) + extraPeriod);
  totalOut.textContent = formatCurrency(lastResult.totalPayment);
  interestOut.textContent = formatCurrency(lastResult.totalInterest);
  if (activeView === 'monthly') renderMonthlyTable(lastResult.schedule);
  else renderAnnualTable(lastResult.annual);
  if (amortChart && lastResult) renderChart(lastResult.schedule);
});

/* initial setup */
document.addEventListener('DOMContentLoaded', ()=>{
  startYearEl.value = new Date().getFullYear();
  startMonthEl.value = new Date().getMonth();
  calculate();
  window.addEventListener('resize', ()=>{ if (amortChart) amortChart.resize(); });
});
</script>
</body>
</html>
